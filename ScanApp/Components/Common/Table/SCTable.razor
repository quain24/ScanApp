@using SharedExtensions
@typeparam TTableType

@if (GroupedData?.Count > 0)
{
    <MudTable Items="GroupedData" T="KeyValuePair<string, List<TTableType>>" OnRowClick="OnGroupClick"
              FixedHeader="FixedHeader" FixedFooter="FixedFooter" Height="@CalculateHeight()" RowsPerPage="RowsPerPage"
              Class="m-0 p-0" Elevation="0" Bordered="false" Striped="true" Hover="true" Outlined="false" Dense="true" Breakpoint="Breakpoint.None">
        <ToolBarContent>
            @if (Configs?.Count > 0 && _groupables.Count > 0)
            {
                <TableToolbar T="TTableType" Groupables="_groupables" SelectedGroupableChanged="@(s => CreateGroupsBasedOn(s))" SelectedGroupable="SelectedGroupable"
                              OnAddClick="@OpenAddItemDialog" AddVisible="_addingEnabled" AddDisabled="false"
                              OnEditClick="@OpenEditItemDialog" OnFilterClick="@OpenFilterItemDialog" EditVisible="@_editingEnabled" EditDisabled="@(SelectedItem is null && SelectedItems.IsNullOrEmpty())"
                              FilterVisible="@_filteringEnabled" GroupingVisible="@_groupingEnabled" FiltersApplied="@(_filters?.Any() ?? false)"
                              OnRemoveFilterClick="RemoveFilters"></TableToolbar>
            }
        </ToolBarContent>

        <HeaderContent>
            <MudTh Style="@GroupedHeaderStyle">
                Grouped by: @SelectedGroupable.DisplayName
            </MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="@context.Key">@context.Key</MudTd>
        </RowTemplate>
        <ChildRowContent>
            @if (_selectedGroupId == context.Key)
            {
                <MudTable Items="@FilterDataSource(context.Value)" T="TTableType" @bind-SelectedItem="@SelectedItemBoundChild" @bind-SelectedItems="@SelectedItemsBoundChild"
                          RowStyleFunc="RowStyleFunc" MultiSelection="MultiSelection" FixedHeader="true" FixedFooter="true" Height="@CalculateHeight(context.Value?.Count ?? 0, true)"
                          RowsPerPage="RowsPerPage" Class="m-0 p-0" Elevation="0" Striped="false" Bordered="false" Hover="true" Outlined="true" Dense="true" Breakpoint="Breakpoint.None">

                    <ColGroup>
                        @ColumnStyles
                    </ColGroup>

                    <HeaderContent>
                        @foreach (var cfg in Configs)
                        {
                            <MudTh Style="@GroupHeaderStyle">
                                <MudTableSortLabel T="TTableType" Style="font-size: smaller" SortLabel="@cfg.Identifier.ToString()" SortBy="@ChooseSortingAlgorithm(cfg)">
                                    @cfg.DisplayName
                                </MudTableSortLabel>
                            </MudTh>
                        }
                    </HeaderContent>

                    <RowTemplate Context="rowData">
                        @foreach (var cfg in Configs)
                        {
                            <MudTd @key="@(cfg.Identifier.ToString() + rowData.GetHashCode())" Style="@RowStyle" DataLabel="@cfg.DisplayName">@FormatOutput(cfg, rowData)</MudTd>
                        }
                    </RowTemplate>
                    <PagerContent>
                        @if (context.Value.Count > RowsPerPage)
                        {
                            <MudTablePager PageSizeOptions="PageSizeOptions" />
                        }
                    </PagerContent>
                </MudTable>
            }
        </ChildRowContent>

        <PagerContent>
            @if (GroupedData.Count > RowsPerPage)
            {
                <MudTablePager PageSizeOptions="PageSizeOptions" />
            }
        </PagerContent>
    </MudTable>
}
else
{
    <MudTable Items="FilterDataSource(Data)" T="TTableType" @bind-SelectedItem="@SelectedItemBoundChild" @bind-SelectedItems="@SelectedItemsBoundChild"
              RowStyleFunc="RowStyleFunc" MultiSelection="MultiSelection" FixedHeader="FixedHeader" Height="@CalculateHeight()" OnRowClick="@(async args => await OnRowClick(args))"
              RowsPerPage="@RowsPerPage" Class="m-0 p-0" Elevation="0" Bordered="false" Striped="true"
              Hover="true" Outlined="false" Dense="true" Breakpoint="Breakpoint.None">

        <ToolBarContent>
            @if (Configs?.Count > 0 && _groupables.Count > 0)
            {
                <TableToolbar T="TTableType" Groupables="_groupables" SelectedGroupableChanged="@(s => CreateGroupsBasedOn(s))" SelectedGroupable="SelectedGroupable"
                              OnAddClick="@OpenAddItemDialog" AddVisible="_addingEnabled" AddDisabled="false"
                              OnEditClick="@OpenEditItemDialog" OnFilterClick="@OpenFilterItemDialog" EditVisible="@_editingEnabled" EditDisabled="@(SelectedItem is null && SelectedItems.IsNullOrEmpty())"
                              FilterVisible="@_filteringEnabled" GroupingVisible="@_groupingEnabled" FiltersApplied="@(_filters?.Any() ?? false)"
                              OnRemoveFilterClick="RemoveFilters"></TableToolbar>
            }
        </ToolBarContent>

        <ColGroup>
            @ColumnStyles
        </ColGroup>

        <HeaderContent>
            @foreach (var cfg in Configs)
            {
                <MudTh Style="@HeaderStyle">
                    <MudTableSortLabel T="TTableType" Style="font-size: smaller" SortLabel="@cfg.Identifier.ToString()" SortBy="@(ChooseSortingAlgorithm(cfg))">
                        @cfg.DisplayName
                    </MudTableSortLabel>
                </MudTh>
            }
        </HeaderContent>

        <RowTemplate>
            @foreach (var cfg in Configs)
            {
                <MudTd @key="@(cfg.Identifier.ToString() + context.GetHashCode())" Style="@RowStyle" DataLabel="@cfg.DisplayName">@(FormatOutput(cfg, context))</MudTd>
            }
        </RowTemplate>

        <PagerContent>
            @if (Data?.Count > RowsPerPage)
            {
                <MudTablePager PageSizeOptions="PageSizeOptions" />
            }
        </PagerContent>
    </MudTable>
}