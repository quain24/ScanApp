@typeparam TItem
@inject IDialogService DialogService
@inject ISnackbar SnackBar
@using System.Reflection;
@using ScanApp.Common.Extensions
@using ScanApp.Components.Common.ScanAppTable.EditDialog;
@using ScanApp.Components.Common.ScanAppTable.FilterDialog;
@using ScanApp.Components.Common.ScanAppTable.GroupDialog;
@using ScanApp.Components.Common.ScanAppTable.Options;
@using ScanApp.Components.Common.ScanAppTable.Sorter;

@if (Loading)
{
    <MudContainer Fixed="true" Style="width: 100%; height: 500px;">
        <MudProgressCircular Style="position: absolute; left: 50%; margin-left: -10px; top: 50%; margin-top: -10px;"
                             Color="Color.Info" Size="Size.Large" Indeterminate="true" />
    </MudContainer>
}
else
{
    @if (GroupingEnabled)
    {
        <MudTabs Position="@Position.Left" Rounded="true" MaxHeight="600" ApplyEffectsToContainer="true" AlwaysShowScrollButtons="true"
                 Class="mt-8" PanelClass="pa-6">
            @foreach (var group in _groupList)
            {
                <MudTabPanel Text="@GetShorterString(group.Key)">
                    <MudTable Style="@TableStyle" Items="group.ItemGroup" Dense="true" FixedHeader="true" Height="@Height" Breakpoint="Breakpoint.None">
                        <HeaderContent>
                            @for (int i = 0; i < ColumnConfigs.Count; i++)
                            {
                                int local = i;
                                <MudTh @onclick="() => SubSortBy(group.ItemGroup, SubScanAppTableSorter, Properties[local], ColumnConfigs[local].DisplayName)">
                                    @ColumnConfigs[local].DisplayName
                                    @if (SubScanAppTableSorter.AscendingOrder == Properties[local].Name)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.ArrowUpward" />
                                    }
                                    else if (SubScanAppTableSorter.DescendingOrder == Properties[local].Name)
                                    {
                                        <MudIcon Icon="@Icons.Material.Outlined.ArrowDownward" />
                                    }
                                </MudTh>
                            }
                        </HeaderContent>
                        <RowTemplate>
                            @for (int i = 0; i < Properties.Length; i++)
                                        {
                                            int local = i;
                                <MudTd @onclick="() => OpenEditDialog(context)" Style="font-size: small">@Properties[local].GetValue(context)</MudTd>
                                        }
                        </RowTemplate>
                    </MudTable>
                </MudTabPanel>
            }
        </MudTabs>
    }
    else
    {
        <MudPaper Elevation="3" Style="margin: 10px;">
            <MudTable Style="@TableStyle" @bind-SelectedItems="_selectedItems" Items="Items" Dense="true"
                      FixedHeader="true" Height="@Height" Breakpoint="Breakpoint.None" SortLabel="Sort By">
                <HeaderContent>
                    @for (int i = 0; i < ColumnConfigs.Count; i++)
                            {
                                int local = i;
                        <MudTh @onclick="() => SortBy(ScanAppTableSorter, Properties[local], ColumnConfigs[local].DisplayName)">
                            @ColumnConfigs[local].DisplayName
                            @if (ScanAppTableSorter.AscendingOrder == Properties[local].Name)
                                    {
                                <MudIcon Icon="@Icons.Material.Outlined.ArrowUpward" />
                                    }
                                    else if (ScanAppTableSorter.DescendingOrder == Properties[local].Name)
                                    {
                                <MudIcon Icon="@Icons.Material.Outlined.ArrowDownward" />
                                    }
                        </MudTh>
                            }
                </HeaderContent>
                <RowTemplate>
                    @for (int i = 0; i < Properties.Length; i++)
                            {
                                int local = i;
                        <MudTd @onclick="() => OpenEditDialog(context)" Style="font-size: small">@Properties[local].GetValue(context)</MudTd>
                            }
                </RowTemplate>
            </MudTable>
        </MudPaper>
    }
    @if (Options.ShowToolBar)
    {
        <MudToolBar>
            <MudToolBarSpacer />
            @if (MenuOpened)
            {
                @if (Options.AllowGrouping)
                {
                    @if (!GroupingEnabled && Options.AllowFiltering)
                    {
                        <MudIconButton OnClick="() => OpenFilterDialog(ScanAppTableSorter, Items)" Icon="@Icons.Material.Outlined.CleaningServices"></MudIconButton>
                    }
                    <MudIconButton OnClick="() => OpenGroupDialog()" Icon="@Icons.Material.Outlined.Group"></MudIconButton>
                }
                else
                {
                    if (Options.AllowFiltering)
                    {
                        <MudIconButton OnClick="() => OpenFilterDialog(ScanAppTableSorter, Items)" Icon="@Icons.Material.Outlined.CleaningServices"></MudIconButton>
                    }
                }
                @if (DataIsFiltered && !GroupingEnabled)
                {
                    <MudIconButton Icon="@Icons.Material.Outlined.Refresh" OnClick="() => ResetFilter(ScanAppTableSorter)"></MudIconButton>
                }
                @if (GroupingEnabled)
                {
                    <MudIconButton OnClick="ToggleGroupingMenu" Icon="@Icons.Material.Outlined.ArrowBack"></MudIconButton>
                }
                <MudIconButton OnClick="ToggleMenu" Icon="@Icons.Material.Outlined.Close"></MudIconButton>
            }
            else
            {
                <MudIconButton OnClick="ToggleMenu" Icon="@Icons.Material.Outlined.Menu"></MudIconButton>
            }
        </MudToolBar>
    }
}

@code
{
    [Parameter]
    public List<TItem> Items { get; set; } = new List<TItem>(0);

    [Parameter]
    public EventCallback<List<TItem>> ItemsChanged { get; set; }

    [Parameter]
    public EventCallback ValuesChanged { get; set; }

    [Parameter]
    public List<ColumnConfig<TItem>> ColumnConfigs { get; set; }

    [Parameter]
    public List<object> ColumnValidators { get; set; }

    [Parameter]
    public ScanAppTableOptions Options { get; set; }

    [Parameter]
    public string Height { get; set; }

    [Parameter]
    public string TableStyle { get; set; }

    [Parameter]
    public RenderFragment<TItem> ChildContent { get; set; }

    [Parameter]
    public Action<TItem> SaveChanges { get; set; }

    [Parameter]
    public Func<Task> GetData { get; set; }

    [Parameter]
    public Action<List<TItem>> DeleteData { get; set; }

    [Parameter]
    public DialogOptions DialogOptions { get; set; }

    private PropertyInfo[] Properties { get; set; }
    private ScanAppTableSorter<TItem> ScanAppTableSorter { get; set; }
    private ScanAppTableSorter<TItem> SubScanAppTableSorter { get; set; }
    private List<TItem> ItemsOriginal { get; set; }
    private bool DataIsFiltered { get; set; }
    private bool MenuOpened { get; set; }
    private bool GroupingEnabled { get; set; }
    private bool Loading { get; set; } = true;

    private List<Group<TItem>> _groupList { get; set; } = new();
    private HashSet<TItem> _selectedItems = new();

    private void InvokeSaveChanges(TItem titem)
    {
        SaveChanges?.Invoke(titem);
        ValuesChanged.InvokeAsync();
    }

    private async Task InvokeGetData()
    {
        Loading = true;
        await GetData();
        await ValuesChanged.InvokeAsync();
        Loading = false;
    }

    private async Task InvokeDeleteData(List<TItem> itemList)
    {
        DeleteData?.Invoke(itemList);
        await InvokeGetData();
    }

    protected override async Task OnInitializedAsync()
    {
        await InvokeGetData();
        ItemsOriginal = Items;
        ScanAppTableSorter = new ScanAppTableSorter<TItem>();
        SubScanAppTableSorter = new ScanAppTableSorter<TItem>();

        DialogOptions ??= new DialogOptions { MaxWidth = MaxWidth.Large };

        Properties = Items.FirstOrDefault()?.GetType().GetProperties();

        ColumnValidators = GetColumnValidatorObjects();
    }

    private void ToggleMenu()
    {
        MenuOpened = !MenuOpened;
    }

    private async Task OpenEditDialog(TItem item)
    {
        var itemClone = ItemCloner.CloneJson(item);
        var parameter = new DialogParameters
        {
            ["Item"] = itemClone,
            ["ColumnConfigs"] = ColumnConfigs,
            ["ColumnValidators"] = ColumnValidators,
            ["Properties"] = Properties

        };
        var dialog = DialogService.Show<ScanAppTableEditDialog<TItem>>("Edit", parameter, DialogOptions);
        var result = await dialog.Result;
        if (result.Cancelled)
        {
            return;
        }

        if (GroupingEnabled)
        {
            var groupWithEditedItem = _groupList
                .Select(g => g.ItemGroup)
                .Where(g => g.Contains(item))
                .ToList()
                .First();

            groupWithEditedItem[groupWithEditedItem.IndexOf(item)] = (TItem)result.Data;
        }

        if (DataIsFiltered)
        {
            ItemsOriginal[ItemsOriginal.IndexOf(item)] = (TItem)result.Data;
        }
        Console.WriteLine(Items.IndexOf(item));
        Items[Items.IndexOf(item)] = (TItem)result.Data;
        InvokeSaveChanges(item);
        StateHasChanged();
    }

    private async Task OpenGroupDialog()
    {
        var parameter = new DialogParameters
        {
            ["Properties"] = Properties,
            ["ColumnConfigs"] = ColumnConfigs,
            ["Items"] = Items
        };
        var dialog = DialogService.Show<ScanAppTableGroupDialog<TItem>>("Group By", parameter);
        var result = await dialog.Result;

        if (result.Cancelled)
        {
            return;
        }

        _groupList.Clear();

        _groupList = (List<Group<TItem>>)result.Data;

        if (_groupList.Count == 0)
        {
            return;
        }

        SubScanAppTableSorter.ResetSortingStatus();
        GroupingEnabled = true;
    }

    private string GetShorterString(string str)
    {
        if (str.Length > 10)
        {
            str = str.Substring(0, 10);
            return str + "...";
        }
        return str;
    }

    private void ToggleGroupingMenu()
    {
        GroupingEnabled = !GroupingEnabled;
    }

    private async Task OpenFilterDialog(ScanAppTableSorter<TItem> sorter, IEnumerable<TItem> items)
    {
        var parameter = new DialogParameters
        {
            ["Items"] = items,
            ["ColumnConfigs"] = ColumnConfigs,
            ["Properties"] = Properties,
            ["Options"] = Options
        };
        var dialog = DialogService.Show<ScanAppTableFilterDialog<TItem>>("Filter", parameter, DialogOptions);
        var result = await dialog.Result;
        if (result.Cancelled)
        {
            return;
        }
        ItemsOriginal = Items;
        Items = (List<TItem>)result.Data;
        DataIsFiltered = true;
        sorter.ResetSortingStatus();
        StateHasChanged();
    }

    private async Task ResetFilter(ScanAppTableSorter<TItem> sorter)
    {
        DataIsFiltered = false;
        sorter.ResetSortingStatus();
        Items = ItemsOriginal;
    }

    private EventCallback SortBy(ScanAppTableSorter<TItem> sorter, PropertyInfo propertyInfo, string header)
    {
        sorter.CurrentlySorted = header;
        var direction = sorter.ResolveSortDirection(propertyInfo);
        Items = sorter.OrderByPropertyName(Items, propertyInfo.Name, direction);

        return EventCallback.Empty;
    }

    private EventCallback SubSortBy(IEnumerable<TItem> items, ScanAppTableSorter<TItem> sorter, PropertyInfo propertyInfo, string header)
    {
        // Recognise which item group it is
        for (int i = 0; i < _groupList.Count; i++)
        {
            if (_groupList[i].ItemGroup[0].Equals(items.First<TItem>()))
            {
                sorter.CurrentlySorted = header;
                var direction = sorter.ResolveSortDirection(propertyInfo);
                _groupList[i].ItemGroup = sorter.OrderByPropertyName(_groupList[i].ItemGroup, propertyInfo.Name, direction).ToList();
                break;
            }
        }
        return EventCallback.Empty;
    }

    private List<object> GetColumnValidatorObjects()
    {
        List<object> CorrectValidators = new List<object>();
        foreach (var columnValidator in ColumnValidators)
        {
            if (columnValidator.GetType().Name == "ColumnValidator`1")
            {
                CorrectValidators.Add(columnValidator);
            }
        }
        return CorrectValidators;
    }
}