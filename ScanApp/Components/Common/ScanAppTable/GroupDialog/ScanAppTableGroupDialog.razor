@typeparam TItem
@using System.Reflection;
@using ScanApp.Components.Common.ScanAppTable.Extensions
@using ScanApp.Components.Common.ScanAppTable.Options
@using SharedExtensions

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Outlined.Group" />
            Group By
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudSelect T="string" Label="Group By" @bind-Value="_selectedGroupBy">
            @for (int i = 0; i < Properties.Length; i++)
            {
                int localIterator = i;
                if (!ColumnConfigs[localIterator].IsGroupable)
                {
                    continue;
                }
                <MudSelectItem Value="@ColumnConfigs[localIterator].DisplayName" />
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Error" OnClick="Cancel">Cancel</MudButton>
        @if (_selectedGroupBy.IsNullOrEmpty())
        {
            <MudButton Color="Color.Primary" Disabled="true">Ok</MudButton>
        }
        else
        {
            <MudButton Color="Color.Primary" OnClick="Submit">Ok</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public IEnumerable<TItem> Items { get; set; }

    [Parameter]
    public List<ColumnConfig<TItem>> ColumnConfigs { get; set; }

    [Parameter]
    public PropertyInfo[] Properties { get; set; }

    private string _selectedGroupBy;
    private bool SubmitDisabled;
    private Dictionary<string, string> _headersPropertiesPairs;

    protected override Task OnInitializedAsync()
    {
        _headersPropertiesPairs = new Dictionary<string, string>();
        for (int i = 0; i < Properties.Length; i++)
        {
            _headersPropertiesPairs.Add(ColumnConfigs[i].DisplayName, Properties[i].Name);
        }
        return base.OnInitializedAsync();
    }

    public void Cancel()
    {
        MudDialog.Close(DialogResult.Cancel());
    }

    public void Submit()
    {
        if (_selectedGroupBy.IsNullOrEmpty())
        {
            return;
        }

        if (!_headersPropertiesPairs.TryGetValue(_selectedGroupBy, out string propertyName))
        {
            return;
        }
        var groupingList = Items.GroupByReflected(propertyName).ToList();
        var groupList = GroupingToGroupConverter.Convert(groupingList);

        MudDialog.Close(DialogResult.Ok(groupList));

    }
}