@using ScanApp.Components.Common.ScanAppTable.Options
@using ScanApp.Models.SpareParts
@using FluentValidation
@using System.Data
@using Microsoft.EntityFrameworkCore.Metadata.Internal
@using ScanApp.Common
@using ScanApp.Common.Extensions
@typeparam TItem

@if (!ColumnConfigs[Iterator].IsEditable)
{
    <MudField Label="@ColumnConfigs[Iterator].DisplayName" Variant="Variant.Filled">@ItemRepresentation.Objects[Iterator].ToString()</MudField>
}
else
{
    @switch (ItemRepresentation.Objects[Iterator])
    {
        case string str:
            <MudTextField @bind-Value="@ItemRepresentation.Strings[Iterator]" @onkeypress="KeyPressed" Immediate="true"
                          Label="@ColumnConfigs[Iterator].DisplayName" Validation="@GetValidator(ColumnConfigs[Iterator].PropertyName)"
                          Variant="Variant.Outlined"></MudTextField>
            break;

        case int integer:
            <MudTextField @bind-Value="@ItemRepresentation.Ints[Iterator]" @onkeypress="KeyPressed" Immediate="true"
                          Label="@ColumnConfigs[Iterator].DisplayName" Validation="@GetValidator(ColumnConfigs[Iterator].PropertyName)"
                          Variant="Variant.Outlined"></MudTextField>
            break;

        case DateTime datetime:
            <MudDatePicker Elevation="7" PickerVariant="PickerVariant.Dialog" Label="@ColumnConfigs[Iterator].DisplayName"
                           @bind-Date="@ItemRepresentation.DateTimes[Iterator]" Validation="@GetValidator(ColumnConfigs[Iterator].PropertyName)"
                           Editable="true" ShowWeekNumbers="true" />
            break;

        case double dbl:
            <MudTextField @bind-Value="@ItemRepresentation.Doubles[Iterator]" @onkeypress="KeyPressed" Immediate="true"
                          Label="@ColumnConfigs[Iterator].DisplayName" Validation="@GetValidator(ColumnConfigs[Iterator].PropertyName)"
                          Variant="Variant.Outlined"></MudTextField>
            break;

        case decimal dec:
            <MudTextField @bind-Value="@ItemRepresentation.Decimals[Iterator]" @onkeypress="KeyPressed" Immediate="true"
                          Label="@ColumnConfigs[Iterator].DisplayName" Validation="@GetValidator(ColumnConfigs[Iterator].PropertyName)"
                          Variant="Variant.Outlined"></MudTextField>
            break;
    }
}

@code {

    [Parameter]
    public List<ColumnConfig<TItem>> ColumnConfigs { get; set; }

    [Parameter]
    public List<object> ColumnValidators { get; set; }

    [Parameter]
    public EventCallback<KeyboardEventArgs> KeyPressed { get; set; }

    [Parameter]
    public int Iterator { get; set; }

    [Parameter]
    public ItemRepresentation<TItem> ItemRepresentation { get; set; }

    private dynamic GetValidator(string propertyName)
    {
        foreach (var columnValidator in ColumnValidators)
        {
            dynamic columnValidatorDyn = columnValidator;
            if (propertyName == columnValidatorDyn.PropertyName)
            {
                return columnValidatorDyn.Validator.Validation;
            }
        }
        return null;
    }
}