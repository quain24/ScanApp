@using ScanApp.Models.HesHub.DeparturePlans
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Calendars

<MudDialog>
    <DialogContent>
        <MudTextField @bind-Value="Data.Subject" OnKeyDown="OnKeyDownPress" />
        <MudTextField @bind-Value="Data.Description" OnKeyDown="OnKeyDownPress" Lines="5" />
        <MudDatePicker @bind-Date="Data.StartDatePortion" AutoClose="true" AllowKeyboardInput="true"></MudDatePicker>
        <MudTimePicker @bind-Time="Data.StartTimePortion" AutoClose="true" AllowKeyboardInput="true"></MudTimePicker>
        <MudDatePicker @bind-Date="Data.EndDatePortion" AutoClose="true" AllowKeyboardInput="true"></MudDatePicker>
        <MudTimePicker @bind-Time="Data.EndTimePortion" AutoClose="true" AllowKeyboardInput="true"></MudTimePicker>
        <MudTextField @bind-Value="Data.RecurrenceException" ReadOnly="false" />
        @* Show recurrence editor only when appointment is not an exception. *@
        @if (EditAction is CurrentAction.EditSeries or CurrentAction.EditFollowingEvents or CurrentAction.Add or CurrentAction.Save)
        {
            <SfRecurrenceEditor @bind-Value="Data.RecurrenceRule"></SfRecurrenceEditor>
        }

    </DialogContent>

    <DialogActions>
        <MudButton Class="mr-auto" Variant="Variant.Filled" Color="Color.Primary" Disabled="!_success" OnClick="Submit">Submit</MudButton>
        <MudButton Class="ml-auto" Variant="Variant.Filled" Color="Color.Warning" OnClick="Cancel">Cancel</MudButton>
        <MudButton Class="mr-auto" Variant="Variant.Filled" Color="Color.Error" Disabled="!_success" OnClick="Delete">Delete</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] protected MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public DeparturePlanGuiModel Data { get; set; }
    [Parameter]
    public CurrentAction? DeleteAction { get; set; }
    [Parameter]
    public CurrentAction? EditAction { get; set; }

    private bool _success = true;
    private readonly Type _returnType = typeof(ValueTuple<,>).MakeGenericType(typeof(DeparturePlanGuiModel), typeof(CurrentAction?));

    public async Task Submit()
    {
        MudDialog.Close(DialogResult.Ok((Data, EditAction), _returnType));
    }

    public async Task Delete()
    {
        MudDialog.Close(DialogResult.Ok((Data, DeleteAction), _returnType));
    }

    public void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task OnKeyDownPress(KeyboardEventArgs args)
    {
        switch (args.Key)
        {
            case "Enter":
                await Submit();
                break;

            case "Escape":
                Cancel();
                break;
        }
    }
}
